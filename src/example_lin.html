<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>天勤-交易</title>
    <!-- base ui && js -->
    <link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/highlight/styles/atom-one-light.css">
    <link rel="stylesheet" href="tq.css">
</head>

<body>
<div class="container-fluid main-container">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">客户示例
                <span class="pull-right STATE">
                        <span class="label label-danger">停止</span>
                    </span>
            </h3>
        </div>
        <ul class="list-group inputs" style="font-size:12px;">
            <li class="list-group-item tq-container">
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">合约代码</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="text" class="form-control input-sm" placeholder="合约代码" value="SHFE.rb1810" id="symbol">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">小周期值</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="60" id="b_dur">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">小周期可开多单手数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="1" id="b_buy_vol">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">小周期可开空单手数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="2" id="b_sell_vol">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">小周期建仓成本优化参数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="45" id="p0">
                    </div>
                </div>

                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">大周期值</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="3600" id="c_dur">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">大周期可开多单手数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="3" id="c_buy_vol">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">大周期可开空单手数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="4" id="c_sell_vol">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">大周期建仓成本优化参数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="65" id="q0">
                    </div>
                </div>

                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">建仓最低盈亏比</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="2.5" id="r0">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">回算反向 SAR1 的 K 线个数</span>
                    </div>
                    <div class="col col-xs-9">
                        <input type="number" class="form-control input-sm" value="10" id="n">
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">SAR形态</span>
                    </div>
                    <div class="col col-xs-9">
                        短周期形态：<span id="B_State"></span>; 长周期形态：<span  id="C_State"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">双向止盈价格</span>
                    </div>
                    <div class="col col-xs-9">
                        买方向：<span id="Cd_Buy"></span>; 卖方向：<span  id="Cd_Sell"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col col-xs-3">
                        <span class="pull-right">双向止盈价格</span>
                    </div>
                    <div class="col col-xs-9">
                        看涨周期 R：<span id="R_Buy"></span>, r0: <span  id="show_r0"></span>;
                        看跌周期 R：<span  id="R_Sell"></span>, 1/r0: <span  id="show_1r0"></span>
                    </div>
                </div>
            </li>
        </ul>
        <li class="list-group-item">
            <div class="row">
                <div class="col col-xs-12">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-xs">
                            <button type="button" class="btn btn-default START" id='START'>
                                开始
                            </button>
                        </div>
                        <div class="btn-group btn-group-xs">
                            <button type="button" class="btn btn-default STOP" id='STOP'>
                                停止
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </li>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
            <h4 class="panel-title">
                <a role="button" data-toggle="collapse" href="#collapse" aria-expanded="true" aria-controls="collapse">
                    说明：本页面为下单代码示例
                    <span id='collapse_arrow' class="glyphicon glyphicon-menu-down pull-right"></span>
                </a>
            </h4>
        </div>
        <div id="collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
            <ul class="list-group" style="font-size:12px;">
                <li class="list-group-item">
                    <div class="row">
                        <div class="col col-xs-12">
                            <b>详细说明：</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col col-xs-12">
                            <p>1. 周期全部以秒为单位</p>
                            <p>3秒线 : 3</p>
                            <p>1分钟线 : 60</p>
                            <p>5分钟线 : 300</p>
                            <p>15分钟线 : 900</p>
                            <p>1小时线 : 3600</p>
                            <p>日线 : 86400</p>
                        </div>
                    </div>
                </li>
                <li class="list-group-item">
                    <div class="row">
                        <div class="col col-xs-12">
                            <b>源代码：</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col col-xs-12" id="code_container">
                            <pre><code class="javascript"></code></pre>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading" role="tab">
            <h4 class="panel-title">
                操作记录:
            </h4>
        </div>
        <div >
            <ul class="list-group" style="font-size:12px;" id="operation">

            </ul>
        </div>
    </div>
</div>

<script type="text/javascript" src="assets/jquery.min.js"></script>
<script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="assets/noty.js"></script>
<script type="text/javascript" src="assets/jquery.autocomplete.min.js"></script>

<!-- del:start -->
<script type="text/javascript" src="libs/modules/utils.js"></script>
<script type="text/javascript" src="libs/modules/color.js"></script>
<script type="text/javascript" src="libs/modules/event.js"></script>
<script type="text/javascript" src="libs/modules/datamanager.js"></script>
<script type="text/javascript" src="libs/modules/indDefineCtx.js"></script>
<script type="text/javascript" src="libs/modules/indRunCtx.js"></script>
<script type="text/javascript" src="libs/modules/tamanager.js"></script>
<script type="text/javascript" src="libs/modules/taskmanager.js"></script>
<script type="text/javascript" src="libs/modules/websocket.js"></script>
<!-- del:end -->
<script type="text/javascript" src="libs/func/basefuncs.js"></script>
<script type="text/javascript" src="libs/tqsdk.js"></script>
<script type="text/javascript" src="libs/ind/sar.js"></script>
<script type="text/javascript" src="libs/custom/sarFsar.js"></script>

<script type="text/javascript" id='TRADE-CODE'>
    $('#symbol').autocomplete({
        lookup: countries,
    });


    const TQ = new TQSDK();
    const STATE_UP = 1;
    const STATE_DOWN = 2;
    const STATE_UP_CROSS = 3;
    const STATE_DOWN_CROSS = 4;

    function fixed(num, n=2){
        return Number(num.toFixed(n));
    }

    // 计算盈亏比
    function cal_R(sar_sell, sar_buy, price){
        let R = (sar_sell - price)/(price - sar_buy);
        return fixed(Math.abs(R), 4);
    }

    // 计算止盈线
    function cal_Cd(price, sar, r0){
        return fixed(price + r0 * (price - sar));
    }

    function getState(serial, ui_id){
        var id = serial._ds.last_id;
        var res_serial = serial.outs.Sar((id-1000<0)?0:id-1000, id);
        var cur = serial.outs.Sar(id);
        var result = {
            Sar: 0,
            state: "NULL",
            FSar: 0
        };
        if(!cur) return result;

        result.Sar = cur[0];
        result.state = cur[1].toString() == '#ff0000' ? STATE_UP : STATE_DOWN;
        if(result.state == STATE_UP && serial.DS.low[id] < result.Sar){
            result.state = STATE_UP_CROSS;
            result.FSar = HIGHEST(id-1, serial.DS.high, TQ.UI.n);
        }
        if(result.state == STATE_DOWN && serial.DS.high[id] > result.Sar){
            result.state = STATE_DOWN_CROSS;
            result.FSar = LOWEST(id-1, serial.DS.low, TQ.UI.n);
        }
        TQ.UI[ui_id] = result.state;
        return result;
    }

    function isReverse(B, C){
        if(B.state == STATE_UP && C.state == STATE_DOWN){
            return [B, C];
        }
        if(C.state == STATE_UP && B.state == STATE_DOWN){
            return [C, B];
        }
        return [null, null];
    }


    function close_order(pos, direction, quote, fun){
        var symbol = pos.exchange_id + '.' + pos.instrument_id;
        var volume_today = pos.volume_long_today;
        var volume_his = pos.volume_long_his;
        var price = quote.bid_price1;
        if(direction == 'BUY') {
            volume_today = pos.volume_short_today;
            volume_his = pos.volume_short_his;
            price = quote.ask_price1;
        }
        if(volume_today > 0){
            TQ.INSERT_ORDER({
                symbol,
                direction,
                offset: 'CLOSETODAY',
                volume: volume_today,
                limit_price: price
            });
            if(fun) fun();
        }
        if(volume_his > 0){
            TQ.INSERT_ORDER({
                symbol,
                direction,
                offset: 'CLOSE',
                volume: volume_his,
                limit_price: price
            });
        }
    }

    function* TaskOrder() {
        TQ.SET_STATE('START');
        var params = TQ.UI(); // 读取页面参数
        TQ.UI.show_r0 = params.r0;
        TQ.UI.show_1r0 = 1 / params.r0;

        var quote = TQ.GET_QUOTE(params.symbol);
        var position = TQ.GET_POSITION(params.symbol);
        var b_sar = TQ.NEW_INDICATOR_INSTANCE(sarFsar, params.symbol, params.b_dur, {N0: params.n0});
        var c_sar = TQ.NEW_INDICATOR_INSTANCE(sar, params.symbol, params.c_dur);
        var Cd = {
            buy : -1,
            sell : -1
        }

        // 目标持仓位
        // params.b_buy_vol // 小周期可开多单手数
        // params.b_sell_vol // 小周期可开空单手数
        // params.c_buy_vol
        // params.c_sell_vol

        // ask_price1 卖价  ask_volume1 卖量
        // bid_price1 买价  bid_volume1 买量

        while(true){
            var result = yield {
                CHANGING: function() { return TQ.IS_CHANGING(quote);},
                USER_CLICK_STOP: TQ.ON_CLICK('STOP'),
            };
            if(result.USER_CLICK_STOP) break;

            var B = getState(b_sar, 'B_State');
            var C = getState(c_sar, 'C_State');
            B.p = params.p0;
            C.p = params.q0;
            B.buy_vol = params.b_buy_vol;
            B.sell_vol = params.b_sell_vol;
            C.buy_vol = params.c_buy_vol;
            C.sell_vol = params.c_sell_vol;

            function log(dir, offset, reason){
                var str = "<b>" + dir + "_" + offset + " - b: "+ B.state + "; c: " + C.state + "</b>";
                str += "<p>" + reason +"</p>";
                $('#operation').append("<li class=\"list-group-item\">" + str + "</li>");
            }

            var volume_long = position.volume_long_today + position.volume_long_his;
            var volume_short = position.volume_short_today + position.volume_short_his;
            volume_long = isNaN(volume_long) ? 0 : volume_long;
            volume_short = isNaN(volume_short) ? 0 : volume_short;

            var [long_sar, short_sar] = isReverse(B, C);

            if(long_sar != null){
                //  先运行平仓策略
                if(volume_long > 0 && Cd.buy > -1 && quote.bid_price1 >= Cd.buy){
                    // 有多单，平多单 sell_close
                    close_order(position, 'SELL', quote,
                        log.bind(null, 'SELL', "CLOSE", `bid_price1(${quote.bid_price1}) >= Cd.buy(${Cd.buy})`));
                    TQ.UI.Cd_Buy = Cd.buy = -1;
                }
                if(volume_short > 0 && Cd.sell > -1 && quote.ask_price1 <= Cd.sell) {
                    // 有空单，平空单 buy_close
                    close_order(position, 'BUY', quote,
                        log.bind(null, 'BUY', "CLOSE", `ask_price1(${quote.ask_price1}) <= Cd.sell(${Cd.sell})`));
                    TQ.UI.Cd_Sell = Cd.sell = -1;
                }
                // 开仓策略
                var R_Buy = cal_R(short_sar.Sar, long_sar.Sar, quote.ask_price1);
                var R_Sell = cal_R(short_sar.Sar, long_sar.Sar, quote.bid_price1);
                TQ.UI.R_Buy = R_Buy;
                TQ.UI.R_Sell = R_Sell;

                if(R_Buy > params.r0 && quote.ask_price1 - long_sar.Sar <= long_sar.p && volume_long < long_sar.buy_vol){
                    TQ.INSERT_ORDER({
                        symbol: params.symbol,
                        direction: 'BUY',
                        offset: 'OPEN',
                        volume: long_sar.buy_vol - volume_long,
                        limit_price: quote.ask_price1
                    });
                    Cd.buy = cal_Cd(quote.ask_price1, long_sar.Sar, params.r0);
                    TQ.UI.Cd_Buy = Cd.buy;
                    log('BUY', "OPEN", `R_Buy(${R_Buy}) > r0(${params.r0})`);
                } else if(R_Sell <= 1 / params.r0 && short_sar.Sar - quote.bid_price1 <= short_sar.p && volume_short < short_sar.sell_vol){
                    TQ.INSERT_ORDER({
                        symbol: params.symbol,
                        direction: 'SELL',
                        offset: 'OPEN',
                        volume: short_sar.sell_vol - volume_short,
                        limit_price: quote.bid_price1
                    });
                    Cd.sell = cal_Cd(quote.bid_price1, short_sar.Sar, params.r0);
                    TQ.UI.Cd_Sell = Cd.sell;
                    log('SELL', "OPEN", `R_Sell(${R_Sell}) <= 1 / r0(${1/params.r0})`);
                }
            } else if(C.state == STATE_UP_CROSS ) {
                if(B.state == STATE_DOWN)
                    close_order(position, 'SELL', quote, log.bind(null, 'SELL', "CLOSE", 'C.state == STATE_UP_CROSS && B.state == STATE_DOWN'));
            } else if(C.state == STATE_UP){
                //  先运行平仓策略
                var _sar = 0;
                if(B.state == STATE_UP_CROSS){
                    close_order(position, 'SELL', quote, log.bind(null, 'SELL', "CLOSE", 'C.state == STATE_UP && B.state == STATE_UP_CROSS'));
                } else if (B.state == STATE_UP){
                    _sar = B.Sar;
                } else if (B.state == STATE_DOWN_CROSS){
                    _sar = B.FSar;
                }
                if(_sar != 0 && quote.ask_price1 - _sar <= params.p0 && volume_long < params.c_buy_vol){
                    TQ.INSERT_ORDER({
                        symbol: params.symbol,
                        direction: 'BUY',
                        offset: 'OPEN',
                        volume: params.c_buy_vol - volume_long,
                        limit_price: quote.ask_price1,
                    });
                    TQ.UI.Cd_Buy = Cd.buy = -1; // 取消止盈点？
                    log('BUY', "OPEN", `ask_price1(${quote.ask_price1}) - _sar(${_sar}) <= p0(${params.p0})`);
                }

            } else if(C.state == STATE_DOWN_CROSS){
                if(B.state == STATE_UP)
                    close_order(position, 'BUY', quote, log.bind(null, 'BUY', "CLOSE", 'C.state == STATE_DOWN_CROSS && B.state == STATE_UP'));
            } else if(C.state == STATE_DOWN){
                var _sar = 0;
                if(B.state == STATE_DOWN_CROSS){
                    close_order(position, 'BUY', quote, log.bind(null, 'BUY', "CLOSE", 'C.state == STATE_DOWN && B.state == STATE_DOWN_CROSS'));
                } else if(B.state == STATE_UP_CROSS){
                    _sar = B.FSar;
                } else if (B.state == STATE_DOWN){
                    _sar = B.Sar;
                }
                if(_sar != 0 && _sar - quote.bid_price1 <= params.p0 && volume_short < params.c_sell_vol){
                    TQ.INSERT_ORDER({
                        symbol: params.symbol,
                        direction: 'SELL',
                        offset: 'OPEN',
                        volume: params.c_sell_vol - volume_short,
                        limit_price: quote.bid_price1,
                    });
                    TQ.UI.Cd_Sell = Cd.sell = -1; // 取消止盈点？
                    log('SELL', "OPEN", `_sar(${_sar}) - bid_price1(${quote.bid_price1}) <= p0(${params.p0})`);
                }
            }
        }
        // 任务结束
        TQ.SET_STATE('STOP');
    }

    $('button.START').on('click', function (e) {
        TQ.START_TASK(TaskOrder);
    });
</script>
</body>

</html>
