<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>天勤-交易</title>
    <!-- base ui && js -->
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/highlight/styles/atom-one-light.css">
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="container-fluid main-container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    输入
                    <span class="glyphicon glyphicon-info-sign pull-right"
                    data-toggle="popover" data-trigger="hover" data-placement="bottom" 
                    data-title="说明"
                    data-content="此板块用来输入执行交易需要的参数"></span>
                </h3>
            </div>
            <ul class="list-group">
                <li class="list-group-item">
                    <div class="row" id="QUOTE_TASK_INPUT">
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon" id="basic-addon1">合约A</span>
                                <input type="text" id='instrument_1' class="form-control" placeholder="合约代码A" aria-describedby="basic-addon1">
                            </div>
                        </div>
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon" id="basic-addon2">合约B</span>
                                <input type="text" id='instrument_2' class="form-control" placeholder="合约代码B" aria-describedby="basic-addon2">
                            </div>
                        </div>
                    </div>
                </li>
                <li class="list-group-item">
                    <div class="row" id="TRADER_TASK_INPUT">
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon">买开</span>
                                <input type="number" id='price_buy_open' class="form-control" placeholder="买开">
                            </div>
                        </div>
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon">卖平</span>
                                <input type="number" id='price_sell_close' class="form-control" placeholder="卖平">
                            </div>
                        </div>
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon">卖开</span>
                                <input type="number" id='price_sell_open' class="form-control" placeholder="卖开">
                            </div>
                        </div>
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
            
                                <span class="input-group-addon">买平</span>
                                <input type="number" id='price_buy_close' class="form-control" placeholder="买平">
                            </div>
                        </div>
                        <div class="col col-xs-6 col-sm-3 col-lg-2 no-padding">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon">手数</span>
                                <input type="number" id='volume' class="form-control" placeholder="手数">
                            </div>
                        </div>
                        <div class="col col-xs-6 no-padding">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
            
        <div class="panel panel-default">
            <div class="panel-heading">
                <h5 class="panel-title">
                    <span class="state" id="INSPECT-STATE">
                        <span class="record">
                            <span class="glyphicon glyphicon-record"></span>
                        </span>
                    </span>
                    任务 —— 监视价差
                    <span class="glyphicon glyphicon-info-sign pull-right"
                    data-toggle="popover" data-trigger="hover" data-placement="bottom" 
                    data-title="说明"
                    data-content="执行查看合约价差的任务，任务标题前方的图标指示任务运行的状态。"></span>
                </h5>
            </div>
            <div class="panel-body">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default INSPECT">
                        <span class="glyphicon glyphicon-play"></span>&nbsp;开始监视
                    </button>
                </div>
                <div class="row" style="padding-top: 8px;">
                    <div class="col col-xs-6 col-sm-3">
                        <strong>
                            买入价差:
                            <span class='spread_ask'></span>
                        </strong>
                    </div>
                    <div class="col col-xs-6 col-sm-3">
                        <strong>
                            卖出价差:
                            <span class='spread_bid'></span>
                        </strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default" style="margin-bottom:15px;">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <span class="state" id="TRADER-STATE">
                        <span class="record">
                            <span class="glyphicon glyphicon-record"></span>
                        </span>
                    </span>
                    任务 —— 套利下单
                    <span class="glyphicon glyphicon-info-sign pull-right"
                    data-toggle="popover" data-trigger="hover" data-placement="bottom" 
                    data-title="说明"
                    data-content="执行交易任务，任务标题前方的图标指示任务运行的状态。"></span>
                </h3>
            </div>
            <div class="panel-body">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-default START" data-state="START">
                        <span class="glyphicon glyphicon-play"></span>&nbsp;开始
                    </button>
                    <button type="button" class="btn btn-default STOP">
                        <span class="glyphicon glyphicon-stop"></span>&nbsp;停止
                    </button>
                </div>
            </div>
        </div>
        
        <div class="panel panel-default tasks" style="margin-bottom:15px;font-size:12px;">
            <div class="panel-heading">
                <h3 class="panel-title">
                    任务
                    <span class="glyphicon glyphicon-info-sign pull-right"
                    data-toggle="popover" data-trigger="hover" data-placement="bottom" 
                    data-title="说明"
                    data-content="任务列表，显示了任务名称和运行状态等信息。"></span>
                </h3>
            </div>
            <ul class="list-group">
                <li class="list-group-item">
                    <div class="row">
                        <div class="col col-xs-2"><b>标识</b></div>
                        <div class="col col-xs-2"><b>状态</b></div>
                        <div class="col col-xs-3"><b>操作</b></div>
                        <div class="col col-xs-5"><b>结果</b></div>
                    </div>
                
                </li>
                <li class="list-group-item">

                    <div class="row INSPECT TASK">
                        <div class="col col-xs-2">监视价差</div>
                        <div class="col col-xs-2 STATE">
                            <span class="label label-danger">停止</span>
                        </div>
                        <div class="col col-xs-3">
                            <div class="btn-group btn-group-xs"
                            data-toggle="tooltip" data-trigger="hover" data-placement="bottom" title="开始监视">
                                <button type="button" class="btn btn-default INSPECT">
                                    <span class="glyphicon glyphicon-play"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col col-xs-5">
                            <div class="row">
                                <div class="col col-xs-6 col-sm-3 no-padding">
                                    <strong>
                                        买入价差:
                                        <span class='spread_ask'></span>
                                    </strong>
                                </div>
                                <div class="col col-xs-6 col-sm-3 no-padding">
                                    <strong>
                                        卖出价差:
                                        <span class='spread_bid'></span>
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="list-group-item">

                    <div class="row TRADER TASK">
                        <div class="col col-xs-2">套利下单</div>
                        <div class="col col-xs-2 STATE">
                            <span class="label label-danger">停止</span>
                        </div>
                        <div class="col col-xs-4">
                            <div class="btn-toolbar" role="toolbar">
                                <div class="btn-group btn-group-xs" role="group"
                                data-toggle="tooltip" data-trigger="hover" data-placement="bottom" title="开始">
                                    <button type="button" class="btn btn-default START" data-state="START">
                                        <span class="glyphicon glyphicon-play"></span>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-xs" role="group"
                                data-toggle="tooltip" data-trigger="hover" data-placement="bottom" title="结束" >
                                    <button type="button" class="btn btn-default STOP" >
                                        <span class="glyphicon glyphicon-stop"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="row" style="padding-bottom:5px;">
            <div class="col col-xs-12">
                <div class="btn-toolbar pull-right" role="toolbar">
                    <div class="btn-group btn-group-sm" role="group"
                    data-toggle="tooltip" data-trigger="hover" data-placement="bottom" title="查看帮助">
                        <button class="btn btn-default" type="button"
                         data-toggle="collapse" data-target="#collapseHelp" aria-expanded="false" aria-controls="collapseHelp">
                            <span class="glyphicon glyphicon-question-sign"></span>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm" role="group"
                    data-toggle="tooltip" data-trigger="hover" data-placement="bottom" title="查看源码">
                        <button class="btn btn-default" type="button"
                        data-toggle="collapse" data-target="#collapseCode" aria-expanded="false" aria-controls="collapseCode">
                            <span class="glyphicon glyphicon-hdd"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="padding-bottom:5px;">
            <div class="col col-xs-12 col-md-6">
                <div class="collapse" id="collapseHelp">
                    <div class="panel panel-default">
                        <div class="panel-body">              
                        </div>
                    </div>
                </div>
            </div>
            <div class="col col-xs-12 col-md-6">
                <div class="collapse" id="collapseCode">
                    <div id="code_container">
                        <pre><code class="javascript"></code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="/assets/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/jquery.autocomplete.min.js"></script>

    <script type="text/javascript" src="/assets/highlight/highlight.pack.js"></script>
    <script type="text/javascript" src="/assets/noty.js"></script>

    <script type="text/javascript" src="/js/worker/datamanager.js"></script>
    <script type="text/javascript" src="/js/worker/websocket.js"></script>
    <script type="text/javascript" src="trader_sdk.js"></script>
    <script type="text/javascript" id='TRADE-CODE'>
// 全局变量
var insid_a = 'DCE.jd1805'; // 默认合约A代码，读取用户填写的合约A代码
var insid_b = 'DCE.jd1809'; // 默认合约B代码，读取用户填写的合约B代码
var quote_a = null; // 合约A
var quote_b = null; // 合约B

var task_quote = null; // 监视合约价差任务
var task_trade = null; // 执行交易任务

function* TaskQuote(C) {
    // 显示当前价差
    var spread_ask = quote_a.ask_price1 - quote_b.bid_price1;
    var spread_bid = quote_a.bid_price1 - quote_b.ask_price1;
    $('.spread_ask').text(spread_ask);
    $('.spread_bid').text(spread_bid);

    while (true) {

        var result = yield {
            CHANGED: function () { return C.QUOTE_CHANGED(quote_a) || C.QUOTE_CHANGED(quote_b) },
            TIMEOUT: 20000
        };

        if (result.CHANGED) {
            $('.spread_bid').text(quote_a.bid_price1 - quote_b.ask_price1);
            $('.spread_ask').text(quote_a.ask_price1 - quote_b.bid_price1);
        }
    }
}

function* TaskSpread(C) {
    var short_volume = 0, long_volume = 0;

    var [exchange_id_a, instrument_id_a] = insid_a.split('.');
    var [exchange_id_b, instrument_id_b] = insid_b.split('.');

    var price_buy_open = $('#price_buy_open').val();
    var price_sell_close = $('#price_sell_close').val();
    var price_sell_open = $('#price_sell_open').val();
    var price_buy_close = $('#price_buy_close').val();
    var volume = parseInt($('#volume').val());

    var order_a = {exchange_id: exchange_id_a, instrument_id: instrument_id_a, volume: volume};
    var order_b = {exchange_id: exchange_id_b, instrument_id: instrument_id_b, volume: volume};
    var buy_open = {direction: 'BUY', offset: 'OPEN'};
    var sell_open = {direction: 'SELL', offset: 'OPEN'};
    var buy_close = {direction: 'BUY', offset: 'CLOSE'};
    var sell_close = {direction: 'SELL', offset: 'CLOSE'};

    while (true) {
        var result = yield {
            OPEN_BUY: function () { return quote_a.ask_price1 - quote_b.bid_price1 <= price_buy_open && long_volume == 0; },
            CLOSE_SELL: function () { return quote_a.bid_price1 - quote_b.ask_price1 >= price_sell_close && long_volume > 0; },
            OPEN_SELL: function () { return quote_a.bid_price1 - quote_b.ask_price1 >= price_sell_open && short_volume == 0; },
            CLOSE_BUY: function () { return quote_a.ask_price1 - quote_b.bid_price1 <= price_buy_close && short_volume > 0; },
            TIMEOUT: 5000
        };
        
        if (result.OPEN_BUY) {
            //买开
            var task_a = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_a, buy_open));
            var task_b = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_b, sell_open));
            var result = yield {
                FINISHED: [task_a, task_b],
                TIMEOUT: 1000000
            }
            STOP_TASK(task_a);
            STOP_TASK(task_b);
            if (result.FINISHED) {
                long_volume = volume;
            }
        }
        if (result.CLOSE_SELL) {
            //卖平
            var task_a = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_a, sell_close));
            var task_b = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_b, buy_close));
            var result = yield {
                FINISHED: [task_a, task_b],
                TIMEOUT: 1000000
            }
            STOP_TASK(task_a);
            STOP_TASK(task_b);
            if (result.FINISHED) {
                long_volume = volume;
            }
        }
        if (result.OPEN_SELL) {
            //卖开
            var task_a = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_a, sell_open));
            var task_b = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_b, buy_open));
            var result = yield {
                FINISHED: [task_a, task_b],
                TIMEOUT: 1000000
            }
            STOP_TASK(task_a);
            STOP_TASK(task_b);
            console.log(result)
            if (result.FINISHED) {
                short_volume = volume;
            }
        }
        if (result.CLOSE_BUY) {
            //卖平
            var task_a = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_a, buy_close));
            var task_b = START_TASK(MakeSingleOrderByCompetitorPrice, Object.assign({}, order_b, sell_close));
            var result = yield {
                FINISHED: [task_a, task_b],
                TIMEOUT: 1000000
            }
            STOP_TASK(task_a);
            STOP_TASK(task_b);
            if (result.FINISHED) {
                short_volume = volume;
            }
        }
    }
}

// 按照给定参数的对手价下单
function* MakeSingleOrderByCompetitorPrice(C, params) {
    // 合约的行情对象
    var quote = C.GET_QUOTE(params.exchange_id + '.' + params.instrument_id);

    // 整个函数是一个循环, 直至委托单完全成交才退出循环
    while (params.volume > 0) {
        // 价格设定为对手价
        if (params.direction === 'SELL') {
            params.limit_price = quote.bid_price1;
        }
        if (params.direction === 'BUY') {
            params.limit_price = quote.ask_price1;
        }

        var order = C.INSERT_ORDER(params);
        //等待直到委托单状态不再是unknown为止, 或者超过2000毫秒仍然为超时状态
        var result = yield {
            STATUS_FINISHED: function () { return order.status === "FINISHED" },
            TIMEOUT: 5000
        };
        //如果委托单完全成交了则退出循环
        if (result.STATUS_FINISHED) {
            return;
        }
        if (order.status === "ALIVE") {
            //撤销委托单
            C.CANCEL_ORDER(order);
        }

        //在总手数总扣减当前委托单的已成交手数, 回到循环头部按剩余手数重新下单
        params.volume -= (order.volume_orign - order.volume_left);
    }
}


$(function () {
    // TODO: 初始化选择合约输入框

    // 设置默认参数
    $('#instrument_1').val(insid_a);
    $('#instrument_2').val(insid_b);

    $('#price_buy_open').val(160);
    $('#price_sell_close').val(165);
    $('#price_sell_open').val(166);
    $('#price_buy_close').val(160);

    $('#volume').val(2);

    // 监视按钮
    $('button.INSPECT').on('click', function () {
        if (task_quote === null) {
            // 更新全局参数
            insid_a = $('#instrument_1').val();
            insid_b = $('#instrument_2').val();
            quote_a = DM.get_quote(insid_a);
            quote_b = DM.get_quote(insid_b);
            // 开始任务之前，先更新参数
            // 初始化监视任务
            task_quote = START_TASK(TaskQuote);
            flag_stop_inspect = false;
            updateUI_InspectState('START');
        } else {
            STOP_TASK(task_quote);
            flag_stop_inspect = true;
            task_quote = null;
            updateUI_InspectState('STOP');
        }
    });

    // 开始交易按钮
    $('button.START').on('click', function () {
        var cmd = $('button.START').attr('data-state');
        switch (cmd) {
            case 'START':
                // 更新全局参数
                insid_a = $('#instrument_1').val();
                insid_b = $('#instrument_2').val();
                quote_a = DM.get_quote(insid_a);
                quote_b = DM.get_quote(insid_b);
                // 开始任务之前，先更新参数
                if (task_trade === null) task_trade = START_TASK(TaskSpread);
                break;
            case 'PAUSE':
                PAUSE_TASK(task_trade);
                break;
            case 'RESUME':
                RESUME_TASK(task_trade);
                break;
        }
        updateUI_TradeState(cmd);
    });

    // 停止交易按钮
    $('button.STOP').on('click', function () {
        if (task_trade) {
            updateUI_TradeState('STOP');
            STOP_TASK(task_trade);
            task_trade = null;
        }
    });

    // 初始化UI
    $('[data-toggle="tooltip"]').tooltip();
    $('[data-toggle="popover"]').popover()
    initUI_Code();
});
    </script>
    <script>
        // 关于更新 ui 的代码
        function initUI_Code() {
            var html = hljs.highlightAuto($('#TRADE-CODE').text());
            $('#code_container code').html(html.value);
        }

        function updateUI_InspectState(cmd) {
            if (cmd === 'START') {
                $('#INSPECT-STATE .record').addClass('running twinkle');
                $('#INSPECT-STATE .comment').text('正在监视');

                $('button.INSPECT').parent('[data-toggle="tooltip"]').attr('title',"停止监视").tooltip('fixTitle');

                $('button.INSPECT')[0].innerHTML = '<span class="glyphicon glyphicon-stop"></span>&nbsp;停止监视';
                $('button.INSPECT span')[1].className = "glyphicon glyphicon-stop";

                $('div.INSPECT.TASK .STATE')[0].innerHTML = '<span class="label label-success">运行中</span>';
                $('#QUOTE_TASK_INPUT input').attr('readonly', true);
            } else if (cmd === 'STOP') {
                $('#INSPECT-STATE .record').removeClass('running twinkle');
                $('#INSPECT-STATE .comment').text('已停止监视');

                $('button.INSPECT').parent('[data-toggle="tooltip"]').attr('title',"开始监视").tooltip('fixTitle');

                $('button.INSPECT')[0].innerHTML = '<span class="glyphicon glyphicon-play"></span>&nbsp;开始监视';
                $('button.INSPECT span')[1].className = "glyphicon glyphicon-play";
                
                $('div.INSPECT.TASK .STATE')[0].innerHTML = '<span class="label label-danger">停止</span>';

                if(task_trade === null){
                    $('#QUOTE_TASK_INPUT input').attr('readonly', false);
                }
            }
        }

        function updateUI_TradeState(cmd) {
            if (cmd === 'START') {
                $('button.START').attr('data-state', 'PAUSE');
                $('button.START').parent('[data-toggle="tooltip"]').attr('title',"暂停").tooltip('fixTitle');
                $('button.START')[0].innerHTML = '<span class="glyphicon glyphicon-pause"></span>&nbsp;暂停';
                $('button.START span')[1].className = "glyphicon glyphicon-pause";
                
                $('#TRADER-STATE .record').removeClass('paused').addClass('running twinkle');

                $('div.TRADER.TASK .STATE')[0].innerHTML = '<span class="label label-success">运行中</span>';

                $('#QUOTE_TASK_INPUT input').attr('readonly', true);
                $('#TRADER_TASK_INPUT input').attr('readonly', true);
            } else if (cmd === 'PAUSE') {
                $('button.START').attr('data-state', 'RESUME');
                $('button.START').parent('[data-toggle="tooltip"]').attr('title',"恢复").tooltip('fixTitle');
                $('button.START')[0].innerHTML = '<span class="glyphicon glyphicon-play"></span>&nbsp;恢复';

                $('button.START span')[1].className = "glyphicon glyphicon-play";

                $('#TRADER-STATE .record').removeClass('running twinkle').addClass('paused');
                $('div.TRADER.TASK .STATE')[0].innerHTML = '<span class="label label-warning">暂停</span>';
            } else if (cmd === 'RESUME') {
                $('button.START').attr('data-state', 'PAUSE');
                $('button.START').parent('[data-toggle="tooltip"]').attr('title',"暂停").tooltip('fixTitle');
                $('button.START')[0].innerHTML = '<span class="glyphicon glyphicon-pause"></span>&nbsp;暂停';
                $('button.START span')[1].className = "glyphicon glyphicon-pause";

                $('#TRADER-STATE .record').removeClass('paused').addClass('twinkle running');
                $('div.TRADER.TASK .STATE')[0].innerHTML = '<span class="label label-success">运行中</span>';
            } else if (cmd === 'STOP') {
                $('button.START').attr('data-state', 'START');
                $('button.START').parent('[data-toggle="tooltip"]').attr('title',"开始").tooltip('fixTitle');
                $('button.START')[0].innerHTML = '<span class="glyphicon glyphicon-play"></span>&nbsp;开始';
                $('button.START span')[1].className = "glyphicon glyphicon-play";

                $('#TRADER-STATE .record').removeClass('paused running twinkle');
                $('div.TRADER.TASK .STATE')[0].innerHTML = '<span class="label label-danger">停止</span>';
                
                if(task_quote === null){
                    $('#QUOTE_TASK_INPUT input').attr('readonly', false);
                }
                $('#TRADER_TASK_INPUT input').attr('readonly', false);
            }
        }
    </script>
</body>

</html>