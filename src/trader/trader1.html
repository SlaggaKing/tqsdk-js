<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>天勤</title>
    <!-- base ui && js -->
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>

<body style="overflow:scroll;overflow:hidden;">

    <div class="container-fluid main-container">

        <div class="row" id="contents">
            <div class="col col-xs-12 left-menu no-padding">

                <div class="input-group">
                    <span class="input-group-addon" id="basic-addon1">合约</span>
                    <input type="text" id='instrument_id' class="form-control" placeholder="合约代码" aria-describedby="basic-addon1">
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="basic-addon2">手数</span>
                    <input type="number" id='volume' class="form-control" placeholder="手数" aria-describedby="basic-addon2">
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="basic-addon3">价格</span>
                    <input type="number" id='limit_price' class="form-control" placeholder="价格" aria-describedby="basic-addon3">
                </div>
            </div>
        </div>

        <div class="row" id="buttons">
            <div class="col col-xs-12 left-menu no-padding">
                <div class="btn-toolbar" role="toolbar" id='operat'>
                    <div class="btn-group" role="group">
                        <button type="button" id='BUY-OPEN' class="btn btn-success start">买开</button>

                        <button type="button" id='SELL-OPEN' class="btn btn-danger start">卖开</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" id='BUY-CLOSE' class="btn btn-default start">买平</button>

                        <button type="button" id='SELL-CLOSE' class="btn btn-default start">卖平</button>
                    </div>


                    <div class="btn-group" role="group">
                        <button type="button" id='STOP' class="btn btn-info end">停止</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/assets/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/ace-min/ace.js"></script>
    <script type="text/javascript" src="/assets/ace-min/ext-language_tools.js"></script>
    <script type="text/javascript" src="/assets/ace-min/ext-linking.js"></script>
    <script type="text/javascript" src="/assets/noty.js"></script>
    <!-- del:start -->
    <!-- <script type="text/javascript" src="/js/func_store.js"></script> -->
    <script type="text/javascript" src="js/list_menu.js"></script>
    <!-- del:end -->
    <script>
        var uiconfig = {
            inputs: {
                instrument_id: {
                    id: 'instrument_id',
                    type: 'text',
                    default: 'cu1801',
                    memo: '合约代码',
                },
                volume: {
                    id: 'volume',
                    type: 'number',
                    default: 2,
                    memo: '手数',
                },
                limit_price: {
                    id: 'limit_price',
                    type: 'number',
                    default: 52730,
                    memo: '价格',
                },
                direction: {
                    id: 'direction',
                    type: 'options',
                    items: ['BUY', 'SELL'],
                    default: 'BUY',
                    memo: '买卖',
                },
                offset: {
                    id: 'offset',
                    type: 'options',
                    items: ['OPEN', 'CLOSE'],
                    default: 'OPEN',
                    memo: '开平'
                }

            }
        };

        // 不要修改函数名字
        var trade_func = function* (C) {

            // 从页面读取对应的参数
            var order_prarams = C.UI_VALUES;

            var i = 0;

            //整个函数是一个循环, 直至委托单完全成交才退出循环
            while (order_prarams.volume > 0 && i < 10) {
                //按照给定参数报送一个委托单
                var order = C.INSERT_ORDER(order_prarams);
                //等待直到委托单状态不再是unknown为止, 或者超过2000毫秒仍然为超时状态
                var result = yield C.WAIT({
                    "STATUS.FINISHED": function () { return order.status === "FINISHED" },
                    "TIMEOUT": 2000
                });
                console.log(result);
                //如果委托单完全成交了则退出循环
                if (result.status === 'STATUS.FINISHED') {
                    return;
                }
                //撤销委托单
                C.CANCEL_ORDER(order);

                //在总手数总扣减当前委托单的已成交手数, 回到循环头部按剩余手数重新下单
                console.log(order)
                order_prarams.volume -= (order.volume_orign - order.volume_left);
                i++;
            }
        }


        $(function () {

            // 默认参数
            $('#instrument_id').val('cu1801');
            $('#volume').val(2);
            $('#limit_price').val(52730);

            $('#operat').on('click', function (e) {
                var target = e.target;
                if (target.nodeName === 'BUTTON') {
                    var [direction, offset] = target.id.split('-');
                    if(direction === 'STOP'){
                        worker.postMessage({
                            cmd: 'trader_end', content: {}
                        });
                        
                    }else{
                        var exchange_id = "SHFE";
                        var instrument_id = $('#instrument_id').val();
                        var volume = $('#volume').val();
                        volume = parseInt(volume);
                        var limit_price = $('#limit_price').val();
                        limit_price = Number(limit_price)

                        worker.postMessage({
                            cmd: 'trader', content: {
                                name: 'trade_func',
                                code: trade_func.toString(),
                                params: {
                                    exchange_id, instrument_id, volume, limit_price, direction, offset
                                }
                            }
                        });
                    }
                }
            })


        });

        // 执行交易开始回调　不要修改函数名字
        var onTradeStart = function(){
            $('#operat button.start').attr('disabled', true);
        }

        // 执行交易结束回调　不要修改函数名字
        var onTradeEnd = function(){
            $('#operat button.start').attr('disabled', false);
        }
    </script>
    <script type="text/javascript" src="trader_sdk.js"></script>
</body>

</html>